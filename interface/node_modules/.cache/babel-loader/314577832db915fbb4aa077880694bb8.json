{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Util_1 = require(\"./Util\");\n\nvar Factory_1 = require(\"./Factory\");\n\nvar Canvas_1 = require(\"./Canvas\");\n\nvar Global_1 = require(\"./Global\");\n\nvar DragAndDrop_1 = require(\"./DragAndDrop\");\n\nvar Validators_1 = require(\"./Validators\");\n\nexports.ids = {};\nexports.names = {};\n\nvar _addId = function (node, id) {\n  if (!id) {\n    return;\n  }\n\n  exports.ids[id] = node;\n};\n\nexports._removeId = function (id, node) {\n  if (!id) {\n    return;\n  }\n\n  if (exports.ids[id] !== node) {\n    return;\n  }\n\n  delete exports.ids[id];\n};\n\nexports._addName = function (node, name) {\n  if (name) {\n    if (!exports.names[name]) {\n      exports.names[name] = [];\n    }\n\n    exports.names[name].push(node);\n  }\n};\n\nexports._removeName = function (name, _id) {\n  if (!name) {\n    return;\n  }\n\n  var nodes = exports.names[name];\n\n  if (!nodes) {\n    return;\n  }\n\n  for (var n = 0; n < nodes.length; n++) {\n    var no = nodes[n];\n\n    if (no._id === _id) {\n      nodes.splice(n, 1);\n    }\n  }\n\n  if (nodes.length === 0) {\n    delete exports.names[name];\n  }\n};\n\nvar ABSOLUTE_OPACITY = 'absoluteOpacity',\n    ABSOLUTE_TRANSFORM = 'absoluteTransform',\n    ABSOLUTE_SCALE = 'absoluteScale',\n    CANVAS = 'canvas',\n    CHANGE = 'Change',\n    CHILDREN = 'children',\n    KONVA = 'konva',\n    LISTENING = 'listening',\n    MOUSEENTER = 'mouseenter',\n    MOUSELEAVE = 'mouseleave',\n    NAME = 'name',\n    SET = 'set',\n    SHAPE = 'Shape',\n    SPACE = ' ',\n    STAGE = 'stage',\n    TRANSFORM = 'transform',\n    UPPER_STAGE = 'Stage',\n    VISIBLE = 'visible',\n    TRANSFORM_CHANGE_STR = ['xChange.konva', 'yChange.konva', 'scaleXChange.konva', 'scaleYChange.konva', 'skewXChange.konva', 'skewYChange.konva', 'rotationChange.konva', 'offsetXChange.konva', 'offsetYChange.konva', 'transformsEnabledChange.konva'].join(SPACE),\n    SCALE_CHANGE_STR = ['scaleXChange.konva', 'scaleYChange.konva'].join(SPACE);\nvar emptyChildren = new Util_1.Collection();\nvar idCounter = 1;\n\nvar Node = function () {\n  function Node(config) {\n    var _this = this;\n\n    this._id = idCounter++;\n    this.eventListeners = {};\n    this.attrs = {};\n    this.index = 0;\n    this.parent = null;\n    this._cache = new Map();\n    this._lastPos = null;\n    this._batchingTransformChange = false;\n    this._needClearTransformCache = false;\n    this._filterUpToDate = false;\n    this._isUnderCache = false;\n    this.children = emptyChildren;\n    this._dragEventId = null;\n    this.setAttrs(config);\n    this.on(TRANSFORM_CHANGE_STR, function () {\n      if (_this._batchingTransformChange) {\n        _this._needClearTransformCache = true;\n        return;\n      }\n\n      _this._clearCache(TRANSFORM);\n\n      _this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);\n    });\n    this.on('visibleChange.konva', function () {\n      _this._clearSelfAndDescendantCache(VISIBLE);\n    });\n    this.on('listeningChange.konva', function () {\n      _this._clearSelfAndDescendantCache(LISTENING);\n    });\n    this.on('opacityChange.konva', function () {\n      _this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);\n    });\n  }\n\n  Node.prototype.hasChildren = function () {\n    return false;\n  };\n\n  Node.prototype.getChildren = function () {\n    return emptyChildren;\n  };\n\n  Node.prototype._clearCache = function (attr) {\n    if (attr) {\n      this._cache.delete(attr);\n    } else {\n      this._cache.clear();\n    }\n  };\n\n  Node.prototype._getCache = function (attr, privateGetter) {\n    var cache = this._cache.get(attr);\n\n    if (cache === undefined) {\n      cache = privateGetter.call(this);\n\n      this._cache.set(attr, cache);\n    }\n\n    return cache;\n  };\n\n  Node.prototype._getCanvasCache = function () {\n    return this._cache.get(CANVAS);\n  };\n\n  Node.prototype._clearSelfAndDescendantCache = function (attr, forceEvent) {\n    this._clearCache(attr);\n\n    if (forceEvent && attr === ABSOLUTE_TRANSFORM) {\n      this.fire('_clearTransformCache');\n    }\n\n    if (this.isCached()) {\n      return;\n    }\n\n    if (this.children) {\n      this.children.each(function (node) {\n        node._clearSelfAndDescendantCache(attr, true);\n      });\n    }\n  };\n\n  Node.prototype.clearCache = function () {\n    this._cache.delete(CANVAS);\n\n    this._clearSelfAndDescendantCache();\n\n    return this;\n  };\n\n  Node.prototype.cache = function (config) {\n    var conf = config || {};\n    var rect = {};\n\n    if (conf.x === undefined || conf.y === undefined || conf.width === undefined || conf.height === undefined) {\n      rect = this.getClientRect({\n        skipTransform: true,\n        relativeTo: this.getParent()\n      });\n    }\n\n    var width = Math.ceil(conf.width || rect.width),\n        height = Math.ceil(conf.height || rect.height),\n        pixelRatio = conf.pixelRatio,\n        x = conf.x === undefined ? rect.x : conf.x,\n        y = conf.y === undefined ? rect.y : conf.y,\n        offset = conf.offset || 0,\n        drawBorder = conf.drawBorder || false;\n\n    if (!width || !height) {\n      Util_1.Util.error('Can not cache the node. Width or height of the node equals 0. Caching is skipped.');\n      return;\n    }\n\n    width += offset * 2;\n    height += offset * 2;\n    x -= offset;\n    y -= offset;\n    var cachedSceneCanvas = new Canvas_1.SceneCanvas({\n      pixelRatio: pixelRatio,\n      width: width,\n      height: height\n    }),\n        cachedFilterCanvas = new Canvas_1.SceneCanvas({\n      pixelRatio: pixelRatio,\n      width: 0,\n      height: 0\n    }),\n        cachedHitCanvas = new Canvas_1.HitCanvas({\n      pixelRatio: 1,\n      width: width,\n      height: height\n    }),\n        sceneContext = cachedSceneCanvas.getContext(),\n        hitContext = cachedHitCanvas.getContext();\n    cachedHitCanvas.isCache = true;\n\n    this._cache.delete('canvas');\n\n    this._filterUpToDate = false;\n\n    if (conf.imageSmoothingEnabled === false) {\n      cachedSceneCanvas.getContext()._context.imageSmoothingEnabled = false;\n      cachedFilterCanvas.getContext()._context.imageSmoothingEnabled = false;\n    }\n\n    sceneContext.save();\n    hitContext.save();\n    sceneContext.translate(-x, -y);\n    hitContext.translate(-x, -y);\n    this._isUnderCache = true;\n\n    this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);\n\n    this._clearSelfAndDescendantCache(ABSOLUTE_SCALE);\n\n    this.drawScene(cachedSceneCanvas, this, true);\n    this.drawHit(cachedHitCanvas, this, true);\n    this._isUnderCache = false;\n    sceneContext.restore();\n    hitContext.restore();\n\n    if (drawBorder) {\n      sceneContext.save();\n      sceneContext.beginPath();\n      sceneContext.rect(0, 0, width, height);\n      sceneContext.closePath();\n      sceneContext.setAttr('strokeStyle', 'red');\n      sceneContext.setAttr('lineWidth', 5);\n      sceneContext.stroke();\n      sceneContext.restore();\n    }\n\n    this._cache.set(CANVAS, {\n      scene: cachedSceneCanvas,\n      filter: cachedFilterCanvas,\n      hit: cachedHitCanvas,\n      x: x,\n      y: y\n    });\n\n    return this;\n  };\n\n  Node.prototype.isCached = function () {\n    return this._cache.has('canvas');\n  };\n\n  Node.prototype.getClientRect = function (config) {\n    throw new Error('abstract \"getClientRect\" method call');\n  };\n\n  Node.prototype._transformedRect = function (rect, top) {\n    var points = [{\n      x: rect.x,\n      y: rect.y\n    }, {\n      x: rect.x + rect.width,\n      y: rect.y\n    }, {\n      x: rect.x + rect.width,\n      y: rect.y + rect.height\n    }, {\n      x: rect.x,\n      y: rect.y + rect.height\n    }];\n    var minX, minY, maxX, maxY;\n    var trans = this.getAbsoluteTransform(top);\n    points.forEach(function (point) {\n      var transformed = trans.point(point);\n\n      if (minX === undefined) {\n        minX = maxX = transformed.x;\n        minY = maxY = transformed.y;\n      }\n\n      minX = Math.min(minX, transformed.x);\n      minY = Math.min(minY, transformed.y);\n      maxX = Math.max(maxX, transformed.x);\n      maxY = Math.max(maxY, transformed.y);\n    });\n    return {\n      x: minX,\n      y: minY,\n      width: maxX - minX,\n      height: maxY - minY\n    };\n  };\n\n  Node.prototype._drawCachedSceneCanvas = function (context) {\n    context.save();\n\n    context._applyOpacity(this);\n\n    context._applyGlobalCompositeOperation(this);\n\n    var canvasCache = this._getCanvasCache();\n\n    context.translate(canvasCache.x, canvasCache.y);\n\n    var cacheCanvas = this._getCachedSceneCanvas();\n\n    var ratio = cacheCanvas.pixelRatio;\n    context.drawImage(cacheCanvas._canvas, 0, 0, cacheCanvas.width / ratio, cacheCanvas.height / ratio);\n    context.restore();\n  };\n\n  Node.prototype._drawCachedHitCanvas = function (context) {\n    var canvasCache = this._getCanvasCache(),\n        hitCanvas = canvasCache.hit;\n\n    context.save();\n    context.translate(canvasCache.x, canvasCache.y);\n    context.drawImage(hitCanvas._canvas, 0, 0);\n    context.restore();\n  };\n\n  Node.prototype._getCachedSceneCanvas = function () {\n    var filters = this.filters(),\n        cachedCanvas = this._getCanvasCache(),\n        sceneCanvas = cachedCanvas.scene,\n        filterCanvas = cachedCanvas.filter,\n        filterContext = filterCanvas.getContext(),\n        len,\n        imageData,\n        n,\n        filter;\n\n    if (filters) {\n      if (!this._filterUpToDate) {\n        var ratio = sceneCanvas.pixelRatio;\n        filterCanvas.setSize(sceneCanvas.width / sceneCanvas.pixelRatio, sceneCanvas.height / sceneCanvas.pixelRatio);\n\n        try {\n          len = filters.length;\n          filterContext.clear();\n          filterContext.drawImage(sceneCanvas._canvas, 0, 0, sceneCanvas.getWidth() / ratio, sceneCanvas.getHeight() / ratio);\n          imageData = filterContext.getImageData(0, 0, filterCanvas.getWidth(), filterCanvas.getHeight());\n\n          for (n = 0; n < len; n++) {\n            filter = filters[n];\n\n            if (typeof filter !== 'function') {\n              Util_1.Util.error('Filter should be type of function, but got ' + typeof filter + ' instead. Please check correct filters');\n              continue;\n            }\n\n            filter.call(this, imageData);\n            filterContext.putImageData(imageData, 0, 0);\n          }\n        } catch (e) {\n          Util_1.Util.error('Unable to apply filter. ' + e.message + ' This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.');\n        }\n\n        this._filterUpToDate = true;\n      }\n\n      return filterCanvas;\n    }\n\n    return sceneCanvas;\n  };\n\n  Node.prototype.on = function (evtStr, handler) {\n    if (arguments.length === 3) {\n      return this._delegate.apply(this, arguments);\n    }\n\n    var events = evtStr.split(SPACE),\n        len = events.length,\n        n,\n        event,\n        parts,\n        baseEvent,\n        name;\n\n    for (n = 0; n < len; n++) {\n      event = events[n];\n      parts = event.split('.');\n      baseEvent = parts[0];\n      name = parts[1] || '';\n\n      if (!this.eventListeners[baseEvent]) {\n        this.eventListeners[baseEvent] = [];\n      }\n\n      this.eventListeners[baseEvent].push({\n        name: name,\n        handler: handler\n      });\n    }\n\n    return this;\n  };\n\n  Node.prototype.off = function (evtStr, callback) {\n    var events = (evtStr || '').split(SPACE),\n        len = events.length,\n        n,\n        t,\n        event,\n        parts,\n        baseEvent,\n        name;\n\n    if (!evtStr) {\n      for (t in this.eventListeners) {\n        this._off(t);\n      }\n    }\n\n    for (n = 0; n < len; n++) {\n      event = events[n];\n      parts = event.split('.');\n      baseEvent = parts[0];\n      name = parts[1];\n\n      if (baseEvent) {\n        if (this.eventListeners[baseEvent]) {\n          this._off(baseEvent, name, callback);\n        }\n      } else {\n        for (t in this.eventListeners) {\n          this._off(t, name, callback);\n        }\n      }\n    }\n\n    return this;\n  };\n\n  Node.prototype.dispatchEvent = function (evt) {\n    var e = {\n      target: this,\n      type: evt.type,\n      evt: evt\n    };\n    this.fire(evt.type, e);\n    return this;\n  };\n\n  Node.prototype.addEventListener = function (type, handler) {\n    this.on(type, function (evt) {\n      handler.call(this, evt.evt);\n    });\n    return this;\n  };\n\n  Node.prototype.removeEventListener = function (type) {\n    this.off(type);\n    return this;\n  };\n\n  Node.prototype._delegate = function (event, selector, handler) {\n    var stopNode = this;\n    this.on(event, function (evt) {\n      var targets = evt.target.findAncestors(selector, true, stopNode);\n\n      for (var i = 0; i < targets.length; i++) {\n        evt = Util_1.Util.cloneObject(evt);\n        evt.currentTarget = targets[i];\n        handler.call(targets[i], evt);\n      }\n    });\n  };\n\n  Node.prototype.remove = function () {\n    if (this.isDragging()) {\n      this.stopDrag();\n    }\n\n    DragAndDrop_1.DD._dragElements.delete(this._id);\n\n    this._remove();\n\n    return this;\n  };\n\n  Node.prototype._clearCaches = function () {\n    this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);\n\n    this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);\n\n    this._clearSelfAndDescendantCache(ABSOLUTE_SCALE);\n\n    this._clearSelfAndDescendantCache(STAGE);\n\n    this._clearSelfAndDescendantCache(VISIBLE);\n\n    this._clearSelfAndDescendantCache(LISTENING);\n  };\n\n  Node.prototype._remove = function () {\n    this._clearCaches();\n\n    var parent = this.getParent();\n\n    if (parent && parent.children) {\n      parent.children.splice(this.index, 1);\n\n      parent._setChildrenIndices();\n\n      this.parent = null;\n    }\n  };\n\n  Node.prototype.destroy = function () {\n    exports._removeId(this.id(), this);\n\n    var names = (this.name() || '').split(/\\s/g);\n\n    for (var i = 0; i < names.length; i++) {\n      var subname = names[i];\n\n      exports._removeName(subname, this._id);\n    }\n\n    this.remove();\n    return this;\n  };\n\n  Node.prototype.getAttr = function (attr) {\n    var method = 'get' + Util_1.Util._capitalize(attr);\n\n    if (Util_1.Util._isFunction(this[method])) {\n      return this[method]();\n    }\n\n    return this.attrs[attr];\n  };\n\n  Node.prototype.getAncestors = function () {\n    var parent = this.getParent(),\n        ancestors = new Util_1.Collection();\n\n    while (parent) {\n      ancestors.push(parent);\n      parent = parent.getParent();\n    }\n\n    return ancestors;\n  };\n\n  Node.prototype.getAttrs = function () {\n    return this.attrs || {};\n  };\n\n  Node.prototype.setAttrs = function (config) {\n    var key, method;\n\n    if (!config) {\n      return this;\n    }\n\n    for (key in config) {\n      if (key === CHILDREN) {\n        continue;\n      }\n\n      method = SET + Util_1.Util._capitalize(key);\n\n      if (Util_1.Util._isFunction(this[method])) {\n        this[method](config[key]);\n      } else {\n        this._setAttr(key, config[key]);\n      }\n    }\n\n    return this;\n  };\n\n  Node.prototype.isListening = function () {\n    return this._getCache(LISTENING, this._isListening);\n  };\n\n  Node.prototype._isListening = function () {\n    var listening = this.listening(),\n        parent = this.getParent();\n\n    if (listening === 'inherit') {\n      if (parent) {\n        return parent.isListening();\n      } else {\n        return true;\n      }\n    } else {\n      return listening;\n    }\n  };\n\n  Node.prototype.isVisible = function () {\n    return this._getCache(VISIBLE, this._isVisible);\n  };\n\n  Node.prototype._isVisible = function (relativeTo) {\n    var visible = this.visible(),\n        parent = this.getParent();\n\n    if (visible === 'inherit') {\n      if (parent && parent !== relativeTo) {\n        return parent._isVisible(relativeTo);\n      } else {\n        return true;\n      }\n    } else if (relativeTo && relativeTo !== parent) {\n      return visible && parent._isVisible(relativeTo);\n    } else {\n      return visible;\n    }\n  };\n\n  Node.prototype.shouldDrawHit = function () {\n    var layer = this.getLayer();\n    return !layer && this.isListening() && this.isVisible() || layer && layer.hitGraphEnabled() && this.isListening() && this.isVisible();\n  };\n\n  Node.prototype.show = function () {\n    this.visible(true);\n    return this;\n  };\n\n  Node.prototype.hide = function () {\n    this.visible(false);\n    return this;\n  };\n\n  Node.prototype.getZIndex = function () {\n    return this.index || 0;\n  };\n\n  Node.prototype.getAbsoluteZIndex = function () {\n    var depth = this.getDepth(),\n        that = this,\n        index = 0,\n        nodes,\n        len,\n        n,\n        child;\n\n    function addChildren(children) {\n      nodes = [];\n      len = children.length;\n\n      for (n = 0; n < len; n++) {\n        child = children[n];\n        index++;\n\n        if (child.nodeType !== SHAPE) {\n          nodes = nodes.concat(child.getChildren().toArray());\n        }\n\n        if (child._id === that._id) {\n          n = len;\n        }\n      }\n\n      if (nodes.length > 0 && nodes[0].getDepth() <= depth) {\n        addChildren(nodes);\n      }\n    }\n\n    if (that.nodeType !== UPPER_STAGE) {\n      addChildren(that.getStage().getChildren());\n    }\n\n    return index;\n  };\n\n  Node.prototype.getDepth = function () {\n    var depth = 0,\n        parent = this.parent;\n\n    while (parent) {\n      depth++;\n      parent = parent.parent;\n    }\n\n    return depth;\n  };\n\n  Node.prototype._batchTransformChanges = function (func) {\n    this._batchingTransformChange = true;\n    func();\n    this._batchingTransformChange = false;\n\n    if (this._needClearTransformCache) {\n      this._clearCache(TRANSFORM);\n\n      this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM, true);\n    }\n\n    this._needClearTransformCache = false;\n  };\n\n  Node.prototype.setPosition = function (pos) {\n    var _this = this;\n\n    this._batchTransformChanges(function () {\n      _this.x(pos.x);\n\n      _this.y(pos.y);\n    });\n\n    return this;\n  };\n\n  Node.prototype.getPosition = function () {\n    return {\n      x: this.x(),\n      y: this.y()\n    };\n  };\n\n  Node.prototype.getAbsolutePosition = function (top) {\n    var haveCachedParent = false;\n    var parent = this.parent;\n\n    while (parent) {\n      if (parent.isCached()) {\n        haveCachedParent = true;\n        break;\n      }\n\n      parent = parent.parent;\n    }\n\n    if (haveCachedParent && !top) {\n      top = true;\n    }\n\n    var absoluteMatrix = this.getAbsoluteTransform(top).getMatrix(),\n        absoluteTransform = new Util_1.Transform(),\n        offset = this.offset();\n    absoluteTransform.m = absoluteMatrix.slice();\n    absoluteTransform.translate(offset.x, offset.y);\n    return absoluteTransform.getTranslation();\n  };\n\n  Node.prototype.setAbsolutePosition = function (pos) {\n    var origTrans = this._clearTransform(),\n        it;\n\n    this.attrs.x = origTrans.x;\n    this.attrs.y = origTrans.y;\n    delete origTrans.x;\n    delete origTrans.y;\n\n    this._clearCache(TRANSFORM);\n\n    it = this._getAbsoluteTransform();\n    it.invert();\n    it.translate(pos.x, pos.y);\n    pos = {\n      x: this.attrs.x + it.getTranslation().x,\n      y: this.attrs.y + it.getTranslation().y\n    };\n\n    this._setTransform(origTrans);\n\n    this.setPosition({\n      x: pos.x,\n      y: pos.y\n    });\n    return this;\n  };\n\n  Node.prototype._setTransform = function (trans) {\n    var key;\n\n    for (key in trans) {\n      this.attrs[key] = trans[key];\n    }\n  };\n\n  Node.prototype._clearTransform = function () {\n    var trans = {\n      x: this.x(),\n      y: this.y(),\n      rotation: this.rotation(),\n      scaleX: this.scaleX(),\n      scaleY: this.scaleY(),\n      offsetX: this.offsetX(),\n      offsetY: this.offsetY(),\n      skewX: this.skewX(),\n      skewY: this.skewY()\n    };\n    this.attrs.x = 0;\n    this.attrs.y = 0;\n    this.attrs.rotation = 0;\n    this.attrs.scaleX = 1;\n    this.attrs.scaleY = 1;\n    this.attrs.offsetX = 0;\n    this.attrs.offsetY = 0;\n    this.attrs.skewX = 0;\n    this.attrs.skewY = 0;\n    return trans;\n  };\n\n  Node.prototype.move = function (change) {\n    var changeX = change.x,\n        changeY = change.y,\n        x = this.x(),\n        y = this.y();\n\n    if (changeX !== undefined) {\n      x += changeX;\n    }\n\n    if (changeY !== undefined) {\n      y += changeY;\n    }\n\n    this.setPosition({\n      x: x,\n      y: y\n    });\n    return this;\n  };\n\n  Node.prototype._eachAncestorReverse = function (func, top) {\n    var family = [],\n        parent = this.getParent(),\n        len,\n        n;\n\n    if (top && top._id === this._id) {\n      func(this);\n      return;\n    }\n\n    family.unshift(this);\n\n    while (parent && (!top || parent._id !== top._id)) {\n      family.unshift(parent);\n      parent = parent.parent;\n    }\n\n    len = family.length;\n\n    for (n = 0; n < len; n++) {\n      func(family[n]);\n    }\n  };\n\n  Node.prototype.rotate = function (theta) {\n    this.rotation(this.rotation() + theta);\n    return this;\n  };\n\n  Node.prototype.moveToTop = function () {\n    if (!this.parent) {\n      Util_1.Util.warn('Node has no parent. moveToTop function is ignored.');\n      return false;\n    }\n\n    var index = this.index;\n    this.parent.children.splice(index, 1);\n    this.parent.children.push(this);\n\n    this.parent._setChildrenIndices();\n\n    return true;\n  };\n\n  Node.prototype.moveUp = function () {\n    if (!this.parent) {\n      Util_1.Util.warn('Node has no parent. moveUp function is ignored.');\n      return false;\n    }\n\n    var index = this.index,\n        len = this.parent.getChildren().length;\n\n    if (index < len - 1) {\n      this.parent.children.splice(index, 1);\n      this.parent.children.splice(index + 1, 0, this);\n\n      this.parent._setChildrenIndices();\n\n      return true;\n    }\n\n    return false;\n  };\n\n  Node.prototype.moveDown = function () {\n    if (!this.parent) {\n      Util_1.Util.warn('Node has no parent. moveDown function is ignored.');\n      return false;\n    }\n\n    var index = this.index;\n\n    if (index > 0) {\n      this.parent.children.splice(index, 1);\n      this.parent.children.splice(index - 1, 0, this);\n\n      this.parent._setChildrenIndices();\n\n      return true;\n    }\n\n    return false;\n  };\n\n  Node.prototype.moveToBottom = function () {\n    if (!this.parent) {\n      Util_1.Util.warn('Node has no parent. moveToBottom function is ignored.');\n      return false;\n    }\n\n    var index = this.index;\n\n    if (index > 0) {\n      this.parent.children.splice(index, 1);\n      this.parent.children.unshift(this);\n\n      this.parent._setChildrenIndices();\n\n      return true;\n    }\n\n    return false;\n  };\n\n  Node.prototype.setZIndex = function (zIndex) {\n    if (!this.parent) {\n      Util_1.Util.warn('Node has no parent. zIndex parameter is ignored.');\n      return this;\n    }\n\n    if (zIndex < 0 || zIndex >= this.parent.children.length) {\n      Util_1.Util.warn('Unexpected value ' + zIndex + ' for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to ' + (this.parent.children.length - 1) + '.');\n    }\n\n    var index = this.index;\n    this.parent.children.splice(index, 1);\n    this.parent.children.splice(zIndex, 0, this);\n\n    this.parent._setChildrenIndices();\n\n    return this;\n  };\n\n  Node.prototype.getAbsoluteOpacity = function () {\n    return this._getCache(ABSOLUTE_OPACITY, this._getAbsoluteOpacity);\n  };\n\n  Node.prototype._getAbsoluteOpacity = function () {\n    var absOpacity = this.opacity();\n    var parent = this.getParent();\n\n    if (parent && !parent._isUnderCache) {\n      absOpacity *= parent.getAbsoluteOpacity();\n    }\n\n    return absOpacity;\n  };\n\n  Node.prototype.moveTo = function (newContainer) {\n    if (this.getParent() !== newContainer) {\n      this._remove();\n\n      newContainer.add(this);\n    }\n\n    return this;\n  };\n\n  Node.prototype.toObject = function () {\n    var obj = {},\n        attrs = this.getAttrs(),\n        key,\n        val,\n        getter,\n        defaultValue,\n        nonPlainObject;\n    obj.attrs = {};\n\n    for (key in attrs) {\n      val = attrs[key];\n      nonPlainObject = Util_1.Util.isObject(val) && !Util_1.Util._isPlainObject(val) && !Util_1.Util._isArray(val);\n\n      if (nonPlainObject) {\n        continue;\n      }\n\n      getter = typeof this[key] === 'function' && this[key];\n      delete attrs[key];\n      defaultValue = getter ? getter.call(this) : null;\n      attrs[key] = val;\n\n      if (defaultValue !== val) {\n        obj.attrs[key] = val;\n      }\n    }\n\n    obj.className = this.getClassName();\n    return Util_1.Util._prepareToStringify(obj);\n  };\n\n  Node.prototype.toJSON = function () {\n    return JSON.stringify(this.toObject());\n  };\n\n  Node.prototype.getParent = function () {\n    return this.parent;\n  };\n\n  Node.prototype.findAncestors = function (selector, includeSelf, stopNode) {\n    var res = [];\n\n    if (includeSelf && this._isMatch(selector)) {\n      res.push(this);\n    }\n\n    var ancestor = this.parent;\n\n    while (ancestor) {\n      if (ancestor === stopNode) {\n        return res;\n      }\n\n      if (ancestor._isMatch(selector)) {\n        res.push(ancestor);\n      }\n\n      ancestor = ancestor.parent;\n    }\n\n    return res;\n  };\n\n  Node.prototype.isAncestorOf = function (node) {\n    return false;\n  };\n\n  Node.prototype.findAncestor = function (selector, includeSelf, stopNode) {\n    return this.findAncestors(selector, includeSelf, stopNode)[0];\n  };\n\n  Node.prototype._isMatch = function (selector) {\n    if (!selector) {\n      return false;\n    }\n\n    if (typeof selector === 'function') {\n      return selector(this);\n    }\n\n    var selectorArr = selector.replace(/ /g, '').split(','),\n        len = selectorArr.length,\n        n,\n        sel;\n\n    for (n = 0; n < len; n++) {\n      sel = selectorArr[n];\n\n      if (!Util_1.Util.isValidSelector(sel)) {\n        Util_1.Util.warn('Selector \"' + sel + '\" is invalid. Allowed selectors examples are \"#foo\", \".bar\" or \"Group\".');\n        Util_1.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like \"Triangle\".');\n        Util_1.Util.warn('Konva is awesome, right?');\n      }\n\n      if (sel.charAt(0) === '#') {\n        if (this.id() === sel.slice(1)) {\n          return true;\n        }\n      } else if (sel.charAt(0) === '.') {\n        if (this.hasName(sel.slice(1))) {\n          return true;\n        }\n      } else if (this.className === sel || this.nodeType === sel) {\n        return true;\n      }\n    }\n\n    return false;\n  };\n\n  Node.prototype.getLayer = function () {\n    var parent = this.getParent();\n    return parent ? parent.getLayer() : null;\n  };\n\n  Node.prototype.getStage = function () {\n    return this._getCache(STAGE, this._getStage);\n  };\n\n  Node.prototype._getStage = function () {\n    var parent = this.getParent();\n\n    if (parent) {\n      return parent.getStage();\n    } else {\n      return undefined;\n    }\n  };\n\n  Node.prototype.fire = function (eventType, evt, bubble) {\n    if (evt === void 0) {\n      evt = {};\n    }\n\n    evt.target = evt.target || this;\n\n    if (bubble) {\n      this._fireAndBubble(eventType, evt);\n    } else {\n      this._fire(eventType, evt);\n    }\n\n    return this;\n  };\n\n  Node.prototype.getAbsoluteTransform = function (top) {\n    if (top) {\n      return this._getAbsoluteTransform(top);\n    } else {\n      return this._getCache(ABSOLUTE_TRANSFORM, this._getAbsoluteTransform);\n    }\n  };\n\n  Node.prototype._getAbsoluteTransform = function (top) {\n    var at;\n\n    if (top) {\n      at = new Util_1.Transform();\n\n      this._eachAncestorReverse(function (node) {\n        var transformsEnabled = node.transformsEnabled();\n\n        if (transformsEnabled === 'all') {\n          at.multiply(node.getTransform());\n        } else if (transformsEnabled === 'position') {\n          at.translate(node.x() - node.offsetX(), node.y() - node.offsetY());\n        }\n      }, top);\n\n      return at;\n    } else {\n      if (this.parent) {\n        at = this.parent.getAbsoluteTransform().copy();\n      } else {\n        at = new Util_1.Transform();\n      }\n\n      var transformsEnabled = this.transformsEnabled();\n\n      if (transformsEnabled === 'all') {\n        at.multiply(this.getTransform());\n      } else if (transformsEnabled === 'position') {\n        at.translate(this.x() - this.offsetX(), this.y() - this.offsetY());\n      }\n\n      return at;\n    }\n  };\n\n  Node.prototype.getAbsoluteScale = function (top) {\n    var parent = this;\n\n    while (parent) {\n      if (parent._isUnderCache) {\n        top = parent;\n      }\n\n      parent = parent.getParent();\n    }\n\n    var transform = this.getAbsoluteTransform(top);\n    var attrs = transform.decompose();\n    return {\n      x: attrs.scaleX,\n      y: attrs.scaleY\n    };\n  };\n\n  Node.prototype.getAbsoluteRotation = function () {\n    return this.getAbsoluteTransform().decompose().rotation;\n  };\n\n  Node.prototype.getTransform = function () {\n    return this._getCache(TRANSFORM, this._getTransform);\n  };\n\n  Node.prototype._getTransform = function () {\n    var m = new Util_1.Transform(),\n        x = this.x(),\n        y = this.y(),\n        rotation = Global_1.Konva.getAngle(this.rotation()),\n        scaleX = this.scaleX(),\n        scaleY = this.scaleY(),\n        skewX = this.skewX(),\n        skewY = this.skewY(),\n        offsetX = this.offsetX(),\n        offsetY = this.offsetY();\n\n    if (x !== 0 || y !== 0) {\n      m.translate(x, y);\n    }\n\n    if (rotation !== 0) {\n      m.rotate(rotation);\n    }\n\n    if (skewX !== 0 || skewY !== 0) {\n      m.skew(skewX, skewY);\n    }\n\n    if (scaleX !== 1 || scaleY !== 1) {\n      m.scale(scaleX, scaleY);\n    }\n\n    if (offsetX !== 0 || offsetY !== 0) {\n      m.translate(-1 * offsetX, -1 * offsetY);\n    }\n\n    return m;\n  };\n\n  Node.prototype.clone = function (obj) {\n    var attrs = Util_1.Util.cloneObject(this.attrs),\n        key,\n        allListeners,\n        len,\n        n,\n        listener;\n\n    for (key in obj) {\n      attrs[key] = obj[key];\n    }\n\n    var node = new this.constructor(attrs);\n\n    for (key in this.eventListeners) {\n      allListeners = this.eventListeners[key];\n      len = allListeners.length;\n\n      for (n = 0; n < len; n++) {\n        listener = allListeners[n];\n\n        if (listener.name.indexOf(KONVA) < 0) {\n          if (!node.eventListeners[key]) {\n            node.eventListeners[key] = [];\n          }\n\n          node.eventListeners[key].push(listener);\n        }\n      }\n    }\n\n    return node;\n  };\n\n  Node.prototype._toKonvaCanvas = function (config) {\n    config = config || {};\n    var box = this.getClientRect();\n    var stage = this.getStage(),\n        x = config.x !== undefined ? config.x : box.x,\n        y = config.y !== undefined ? config.y : box.y,\n        pixelRatio = config.pixelRatio || 1,\n        canvas = new Canvas_1.SceneCanvas({\n      width: config.width || box.width || (stage ? stage.width() : 0),\n      height: config.height || box.height || (stage ? stage.height() : 0),\n      pixelRatio: pixelRatio\n    }),\n        context = canvas.getContext();\n    context.save();\n\n    if (x || y) {\n      context.translate(-1 * x, -1 * y);\n    }\n\n    this.drawScene(canvas);\n    context.restore();\n    return canvas;\n  };\n\n  Node.prototype.toCanvas = function (config) {\n    return this._toKonvaCanvas(config)._canvas;\n  };\n\n  Node.prototype.toDataURL = function (config) {\n    config = config || {};\n    var mimeType = config.mimeType || null,\n        quality = config.quality || null;\n\n    var url = this._toKonvaCanvas(config).toDataURL(mimeType, quality);\n\n    if (config.callback) {\n      config.callback(url);\n    }\n\n    return url;\n  };\n\n  Node.prototype.toImage = function (config) {\n    if (!config || !config.callback) {\n      throw 'callback required for toImage method config argument';\n    }\n\n    var callback = config.callback;\n    delete config.callback;\n\n    Util_1.Util._urlToImage(this.toDataURL(config), function (img) {\n      callback(img);\n    });\n  };\n\n  Node.prototype.setSize = function (size) {\n    this.width(size.width);\n    this.height(size.height);\n    return this;\n  };\n\n  Node.prototype.getSize = function () {\n    return {\n      width: this.width(),\n      height: this.height()\n    };\n  };\n\n  Node.prototype.getClassName = function () {\n    return this.className || this.nodeType;\n  };\n\n  Node.prototype.getType = function () {\n    return this.nodeType;\n  };\n\n  Node.prototype.getDragDistance = function () {\n    if (this.attrs.dragDistance !== undefined) {\n      return this.attrs.dragDistance;\n    } else if (this.parent) {\n      return this.parent.getDragDistance();\n    } else {\n      return Global_1.Konva.dragDistance;\n    }\n  };\n\n  Node.prototype._off = function (type, name, callback) {\n    var evtListeners = this.eventListeners[type],\n        i,\n        evtName,\n        handler;\n\n    for (i = 0; i < evtListeners.length; i++) {\n      evtName = evtListeners[i].name;\n      handler = evtListeners[i].handler;\n\n      if ((evtName !== 'konva' || name === 'konva') && (!name || evtName === name) && (!callback || callback === handler)) {\n        evtListeners.splice(i, 1);\n\n        if (evtListeners.length === 0) {\n          delete this.eventListeners[type];\n          break;\n        }\n\n        i--;\n      }\n    }\n  };\n\n  Node.prototype._fireChangeEvent = function (attr, oldVal, newVal) {\n    this._fire(attr + CHANGE, {\n      oldVal: oldVal,\n      newVal: newVal\n    });\n  };\n\n  Node.prototype.setId = function (id) {\n    var oldId = this.id();\n\n    exports._removeId(oldId, this);\n\n    _addId(this, id);\n\n    this._setAttr('id', id);\n\n    return this;\n  };\n\n  Node.prototype.setName = function (name) {\n    var oldNames = (this.name() || '').split(/\\s/g);\n    var newNames = (name || '').split(/\\s/g);\n    var subname, i;\n\n    for (i = 0; i < oldNames.length; i++) {\n      subname = oldNames[i];\n\n      if (newNames.indexOf(subname) === -1 && subname) {\n        exports._removeName(subname, this._id);\n      }\n    }\n\n    for (i = 0; i < newNames.length; i++) {\n      subname = newNames[i];\n\n      if (oldNames.indexOf(subname) === -1 && subname) {\n        exports._addName(this, subname);\n      }\n    }\n\n    this._setAttr(NAME, name);\n\n    return this;\n  };\n\n  Node.prototype.addName = function (name) {\n    if (!this.hasName(name)) {\n      var oldName = this.name();\n      var newName = oldName ? oldName + ' ' + name : name;\n      this.setName(newName);\n    }\n\n    return this;\n  };\n\n  Node.prototype.hasName = function (name) {\n    if (!name) {\n      return false;\n    }\n\n    var fullName = this.name();\n\n    if (!fullName) {\n      return false;\n    }\n\n    var names = (fullName || '').split(/\\s/g);\n    return names.indexOf(name) !== -1;\n  };\n\n  Node.prototype.removeName = function (name) {\n    var names = (this.name() || '').split(/\\s/g);\n    var index = names.indexOf(name);\n\n    if (index !== -1) {\n      names.splice(index, 1);\n      this.setName(names.join(' '));\n    }\n\n    return this;\n  };\n\n  Node.prototype.setAttr = function (attr, val) {\n    var func = this[SET + Util_1.Util._capitalize(attr)];\n\n    if (Util_1.Util._isFunction(func)) {\n      func.call(this, val);\n    } else {\n      this._setAttr(attr, val);\n    }\n\n    return this;\n  };\n\n  Node.prototype._setAttr = function (key, val) {\n    var oldVal = this.attrs[key];\n\n    if (oldVal === val && !Util_1.Util.isObject(val)) {\n      return;\n    }\n\n    if (val === undefined || val === null) {\n      delete this.attrs[key];\n    } else {\n      this.attrs[key] = val;\n    }\n\n    this._fireChangeEvent(key, oldVal, val);\n  };\n\n  Node.prototype._setComponentAttr = function (key, component, val) {\n    var oldVal;\n\n    if (val !== undefined) {\n      oldVal = this.attrs[key];\n\n      if (!oldVal) {\n        this.attrs[key] = this.getAttr(key);\n      }\n\n      this.attrs[key][component] = val;\n\n      this._fireChangeEvent(key, oldVal, val);\n    }\n  };\n\n  Node.prototype._fireAndBubble = function (eventType, evt, compareShape) {\n    if (evt && this.nodeType === SHAPE) {\n      evt.target = this;\n    }\n\n    var shouldStop = (eventType === MOUSEENTER || eventType === MOUSELEAVE) && (compareShape && (this === compareShape || this.isAncestorOf && this.isAncestorOf(compareShape)) || this.nodeType === 'Stage' && !compareShape);\n\n    if (!shouldStop) {\n      this._fire(eventType, evt);\n\n      var stopBubble = (eventType === MOUSEENTER || eventType === MOUSELEAVE) && compareShape && compareShape.isAncestorOf && compareShape.isAncestorOf(this) && !compareShape.isAncestorOf(this.parent);\n\n      if ((evt && !evt.cancelBubble || !evt) && this.parent && this.parent.isListening() && !stopBubble) {\n        if (compareShape && compareShape.parent) {\n          this._fireAndBubble.call(this.parent, eventType, evt, compareShape);\n        } else {\n          this._fireAndBubble.call(this.parent, eventType, evt);\n        }\n      }\n    }\n  };\n\n  Node.prototype._fire = function (eventType, evt) {\n    var events = this.eventListeners[eventType],\n        i;\n\n    if (events) {\n      evt = evt || {};\n      evt.currentTarget = this;\n      evt.type = eventType;\n\n      for (i = 0; i < events.length; i++) {\n        events[i].handler.call(this, evt);\n      }\n    }\n  };\n\n  Node.prototype.draw = function () {\n    this.drawScene();\n    this.drawHit();\n    return this;\n  };\n\n  Node.prototype._createDragElement = function (evt) {\n    var pointerId = evt ? evt.pointerId : undefined;\n    var stage = this.getStage();\n    var ap = this.getAbsolutePosition();\n    var pos = stage._getPointerById(pointerId) || stage._changedPointerPositions[0] || ap;\n\n    DragAndDrop_1.DD._dragElements.set(this._id, {\n      node: this,\n      startPointerPos: pos,\n      offset: {\n        x: pos.x - ap.x,\n        y: pos.y - ap.y\n      },\n      dragStatus: 'ready',\n      pointerId: pointerId\n    });\n  };\n\n  Node.prototype.startDrag = function (evt) {\n    if (!DragAndDrop_1.DD._dragElements.has(this._id)) {\n      this._createDragElement(evt);\n    }\n\n    var elem = DragAndDrop_1.DD._dragElements.get(this._id);\n\n    elem.dragStatus = 'dragging';\n    this.fire('dragstart', {\n      type: 'dragstart',\n      target: this,\n      evt: evt && evt.evt\n    }, true);\n  };\n\n  Node.prototype._setDragPosition = function (evt, elem) {\n    var pos = this.getStage()._getPointerById(elem.pointerId);\n\n    if (!pos) {\n      return;\n    }\n\n    var newNodePos = {\n      x: pos.x - elem.offset.x,\n      y: pos.y - elem.offset.y\n    };\n    var dbf = this.dragBoundFunc();\n\n    if (dbf !== undefined) {\n      var bounded = dbf.call(this, newNodePos, evt);\n\n      if (!bounded) {\n        Util_1.Util.warn('dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.');\n      } else {\n        newNodePos = bounded;\n      }\n    }\n\n    if (!this._lastPos || this._lastPos.x !== newNodePos.x || this._lastPos.y !== newNodePos.y) {\n      this.setAbsolutePosition(newNodePos);\n\n      if (this.getLayer()) {\n        this.getLayer().batchDraw();\n      } else if (this.getStage()) {\n        this.getStage().batchDraw();\n      }\n    }\n\n    this._lastPos = newNodePos;\n  };\n\n  Node.prototype.stopDrag = function (evt) {\n    var elem = DragAndDrop_1.DD._dragElements.get(this._id);\n\n    if (elem) {\n      elem.dragStatus = 'stopped';\n    }\n\n    DragAndDrop_1.DD._endDragBefore(evt);\n\n    DragAndDrop_1.DD._endDragAfter(evt);\n  };\n\n  Node.prototype.setDraggable = function (draggable) {\n    this._setAttr('draggable', draggable);\n\n    this._dragChange();\n  };\n\n  Node.prototype.isDragging = function () {\n    var elem = DragAndDrop_1.DD._dragElements.get(this._id);\n\n    return elem ? elem.dragStatus === 'dragging' : false;\n  };\n\n  Node.prototype._listenDrag = function () {\n    this._dragCleanup();\n\n    this.on('mousedown.konva touchstart.konva', function (evt) {\n      var _this = this;\n\n      var shouldCheckButton = evt.evt['button'] !== undefined;\n      var canDrag = !shouldCheckButton || Global_1.Konva.dragButtons.indexOf(evt.evt['button']) >= 0;\n\n      if (!canDrag) {\n        return;\n      }\n\n      if (this.isDragging()) {\n        return;\n      }\n\n      var hasDraggingChild = false;\n\n      DragAndDrop_1.DD._dragElements.forEach(function (elem) {\n        if (_this.isAncestorOf(elem.node)) {\n          hasDraggingChild = true;\n        }\n      });\n\n      if (!hasDraggingChild) {\n        this._createDragElement(evt);\n      }\n    });\n  };\n\n  Node.prototype._dragChange = function () {\n    if (this.attrs.draggable) {\n      this._listenDrag();\n    } else {\n      this._dragCleanup();\n\n      var stage = this.getStage();\n\n      if (stage && DragAndDrop_1.DD._dragElements.has(this._id)) {\n        this.stopDrag();\n      }\n    }\n  };\n\n  Node.prototype._dragCleanup = function () {\n    this.off('mousedown.konva');\n    this.off('touchstart.konva');\n  };\n\n  Node.create = function (data, container) {\n    if (Util_1.Util._isString(data)) {\n      data = JSON.parse(data);\n    }\n\n    return this._createNode(data, container);\n  };\n\n  Node._createNode = function (obj, container) {\n    var className = Node.prototype.getClassName.call(obj),\n        children = obj.children,\n        no,\n        len,\n        n;\n\n    if (container) {\n      obj.attrs.container = container;\n    }\n\n    if (!Global_1._NODES_REGISTRY[className]) {\n      Util_1.Util.warn('Can not find a node with class name \"' + className + '\". Fallback to \"Shape\".');\n      className = 'Shape';\n    }\n\n    var Class = Global_1._NODES_REGISTRY[className];\n    no = new Class(obj.attrs);\n\n    if (children) {\n      len = children.length;\n\n      for (n = 0; n < len; n++) {\n        no.add(Node._createNode(children[n]));\n      }\n    }\n\n    return no;\n  };\n\n  return Node;\n}();\n\nexports.Node = Node;\nNode.prototype.nodeType = 'Node';\nNode.prototype._attrsAffectingSize = [];\nFactory_1.Factory.addGetterSetter(Node, 'zIndex');\nFactory_1.Factory.addGetterSetter(Node, 'absolutePosition');\nFactory_1.Factory.addGetterSetter(Node, 'position');\nFactory_1.Factory.addGetterSetter(Node, 'x', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'y', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'globalCompositeOperation', 'source-over', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'opacity', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'name', '', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'id', '', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'rotation', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addComponentsGetterSetter(Node, 'scale', ['x', 'y']);\nFactory_1.Factory.addGetterSetter(Node, 'scaleX', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'scaleY', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addComponentsGetterSetter(Node, 'skew', ['x', 'y']);\nFactory_1.Factory.addGetterSetter(Node, 'skewX', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'skewY', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addComponentsGetterSetter(Node, 'offset', ['x', 'y']);\nFactory_1.Factory.addGetterSetter(Node, 'offsetX', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'offsetY', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'dragDistance', null, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'width', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'height', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'listening', 'inherit', function (val) {\n  var isValid = val === true || val === false || val === 'inherit';\n\n  if (!isValid) {\n    Util_1.Util.warn(val + ' is a not valid value for \"listening\" attribute. The value may be true, false or \"inherit\".');\n  }\n\n  return val;\n});\nFactory_1.Factory.addGetterSetter(Node, 'preventDefault', true, Validators_1.getBooleanValidator());\nFactory_1.Factory.addGetterSetter(Node, 'filters', null, function (val) {\n  this._filterUpToDate = false;\n  return val;\n});\nFactory_1.Factory.addGetterSetter(Node, 'visible', 'inherit', function (val) {\n  var isValid = val === true || val === false || val === 'inherit';\n\n  if (!isValid) {\n    Util_1.Util.warn(val + ' is a not valid value for \"visible\" attribute. The value may be true, false or \"inherit\".');\n  }\n\n  return val;\n});\nFactory_1.Factory.addGetterSetter(Node, 'transformsEnabled', 'all', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'size');\nFactory_1.Factory.addGetterSetter(Node, 'dragBoundFunc');\nFactory_1.Factory.addGetterSetter(Node, 'draggable', false, Validators_1.getBooleanValidator());\nFactory_1.Factory.backCompat(Node, {\n  rotateDeg: 'rotate',\n  setRotationDeg: 'setRotation',\n  getRotationDeg: 'getRotation'\n});\nUtil_1.Collection.mapMethods(Node);","map":{"version":3,"sources":["/mnt/c/Users/anjul/OneDrive - Stony Brook University/Documents/infographics_generation/interface/node_modules/konva/lib/Node.js"],"names":["Object","defineProperty","exports","value","Util_1","require","Factory_1","Canvas_1","Global_1","DragAndDrop_1","Validators_1","ids","names","_addId","node","id","_removeId","_addName","name","push","_removeName","_id","nodes","n","length","no","splice","ABSOLUTE_OPACITY","ABSOLUTE_TRANSFORM","ABSOLUTE_SCALE","CANVAS","CHANGE","CHILDREN","KONVA","LISTENING","MOUSEENTER","MOUSELEAVE","NAME","SET","SHAPE","SPACE","STAGE","TRANSFORM","UPPER_STAGE","VISIBLE","TRANSFORM_CHANGE_STR","join","SCALE_CHANGE_STR","emptyChildren","Collection","idCounter","Node","config","_this","eventListeners","attrs","index","parent","_cache","Map","_lastPos","_batchingTransformChange","_needClearTransformCache","_filterUpToDate","_isUnderCache","children","_dragEventId","setAttrs","on","_clearCache","_clearSelfAndDescendantCache","prototype","hasChildren","getChildren","attr","delete","clear","_getCache","privateGetter","cache","get","undefined","call","set","_getCanvasCache","forceEvent","fire","isCached","each","clearCache","conf","rect","x","y","width","height","getClientRect","skipTransform","relativeTo","getParent","Math","ceil","pixelRatio","offset","drawBorder","Util","error","cachedSceneCanvas","SceneCanvas","cachedFilterCanvas","cachedHitCanvas","HitCanvas","sceneContext","getContext","hitContext","isCache","imageSmoothingEnabled","_context","save","translate","drawScene","drawHit","restore","beginPath","closePath","setAttr","stroke","scene","filter","hit","has","Error","_transformedRect","top","points","minX","minY","maxX","maxY","trans","getAbsoluteTransform","forEach","point","transformed","min","max","_drawCachedSceneCanvas","context","_applyOpacity","_applyGlobalCompositeOperation","canvasCache","cacheCanvas","_getCachedSceneCanvas","ratio","drawImage","_canvas","_drawCachedHitCanvas","hitCanvas","filters","cachedCanvas","sceneCanvas","filterCanvas","filterContext","len","imageData","setSize","getWidth","getHeight","getImageData","putImageData","e","message","evtStr","handler","arguments","_delegate","apply","events","split","event","parts","baseEvent","off","callback","t","_off","dispatchEvent","evt","target","type","addEventListener","removeEventListener","selector","stopNode","targets","findAncestors","i","cloneObject","currentTarget","remove","isDragging","stopDrag","DD","_dragElements","_remove","_clearCaches","_setChildrenIndices","destroy","subname","getAttr","method","_capitalize","_isFunction","getAncestors","ancestors","getAttrs","key","_setAttr","isListening","_isListening","listening","isVisible","_isVisible","visible","shouldDrawHit","layer","getLayer","hitGraphEnabled","show","hide","getZIndex","getAbsoluteZIndex","depth","getDepth","that","child","addChildren","nodeType","concat","toArray","getStage","_batchTransformChanges","func","setPosition","pos","getPosition","getAbsolutePosition","haveCachedParent","absoluteMatrix","getMatrix","absoluteTransform","Transform","m","slice","getTranslation","setAbsolutePosition","origTrans","_clearTransform","it","_getAbsoluteTransform","invert","_setTransform","rotation","scaleX","scaleY","offsetX","offsetY","skewX","skewY","move","change","changeX","changeY","_eachAncestorReverse","family","unshift","rotate","theta","moveToTop","warn","moveUp","moveDown","moveToBottom","setZIndex","zIndex","getAbsoluteOpacity","_getAbsoluteOpacity","absOpacity","opacity","moveTo","newContainer","add","toObject","obj","val","getter","defaultValue","nonPlainObject","isObject","_isPlainObject","_isArray","className","getClassName","_prepareToStringify","toJSON","JSON","stringify","includeSelf","res","_isMatch","ancestor","isAncestorOf","findAncestor","selectorArr","replace","sel","isValidSelector","charAt","hasName","_getStage","eventType","bubble","_fireAndBubble","_fire","at","transformsEnabled","multiply","getTransform","copy","getAbsoluteScale","transform","decompose","getAbsoluteRotation","_getTransform","Konva","getAngle","skew","scale","clone","allListeners","listener","constructor","indexOf","_toKonvaCanvas","box","stage","canvas","toCanvas","toDataURL","mimeType","quality","url","toImage","_urlToImage","img","size","getSize","getType","getDragDistance","dragDistance","evtListeners","evtName","_fireChangeEvent","oldVal","newVal","setId","oldId","setName","oldNames","newNames","addName","oldName","newName","fullName","removeName","_setComponentAttr","component","compareShape","shouldStop","stopBubble","cancelBubble","draw","_createDragElement","pointerId","ap","_getPointerById","_changedPointerPositions","startPointerPos","dragStatus","startDrag","elem","_setDragPosition","newNodePos","dbf","dragBoundFunc","bounded","batchDraw","_endDragBefore","_endDragAfter","setDraggable","draggable","_dragChange","_listenDrag","_dragCleanup","shouldCheckButton","canDrag","dragButtons","hasDraggingChild","create","data","container","_isString","parse","_createNode","_NODES_REGISTRY","Class","_attrsAffectingSize","Factory","addGetterSetter","getNumberValidator","getStringValidator","addComponentsGetterSetter","isValid","getBooleanValidator","backCompat","rotateDeg","setRotationDeg","getRotationDeg","mapMethods"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Util_1 = require(\"./Util\");\nvar Factory_1 = require(\"./Factory\");\nvar Canvas_1 = require(\"./Canvas\");\nvar Global_1 = require(\"./Global\");\nvar DragAndDrop_1 = require(\"./DragAndDrop\");\nvar Validators_1 = require(\"./Validators\");\nexports.ids = {};\nexports.names = {};\nvar _addId = function (node, id) {\n    if (!id) {\n        return;\n    }\n    exports.ids[id] = node;\n};\nexports._removeId = function (id, node) {\n    if (!id) {\n        return;\n    }\n    if (exports.ids[id] !== node) {\n        return;\n    }\n    delete exports.ids[id];\n};\nexports._addName = function (node, name) {\n    if (name) {\n        if (!exports.names[name]) {\n            exports.names[name] = [];\n        }\n        exports.names[name].push(node);\n    }\n};\nexports._removeName = function (name, _id) {\n    if (!name) {\n        return;\n    }\n    var nodes = exports.names[name];\n    if (!nodes) {\n        return;\n    }\n    for (var n = 0; n < nodes.length; n++) {\n        var no = nodes[n];\n        if (no._id === _id) {\n            nodes.splice(n, 1);\n        }\n    }\n    if (nodes.length === 0) {\n        delete exports.names[name];\n    }\n};\nvar ABSOLUTE_OPACITY = 'absoluteOpacity', ABSOLUTE_TRANSFORM = 'absoluteTransform', ABSOLUTE_SCALE = 'absoluteScale', CANVAS = 'canvas', CHANGE = 'Change', CHILDREN = 'children', KONVA = 'konva', LISTENING = 'listening', MOUSEENTER = 'mouseenter', MOUSELEAVE = 'mouseleave', NAME = 'name', SET = 'set', SHAPE = 'Shape', SPACE = ' ', STAGE = 'stage', TRANSFORM = 'transform', UPPER_STAGE = 'Stage', VISIBLE = 'visible', TRANSFORM_CHANGE_STR = [\n    'xChange.konva',\n    'yChange.konva',\n    'scaleXChange.konva',\n    'scaleYChange.konva',\n    'skewXChange.konva',\n    'skewYChange.konva',\n    'rotationChange.konva',\n    'offsetXChange.konva',\n    'offsetYChange.konva',\n    'transformsEnabledChange.konva',\n].join(SPACE), SCALE_CHANGE_STR = ['scaleXChange.konva', 'scaleYChange.konva'].join(SPACE);\nvar emptyChildren = new Util_1.Collection();\nvar idCounter = 1;\nvar Node = (function () {\n    function Node(config) {\n        var _this = this;\n        this._id = idCounter++;\n        this.eventListeners = {};\n        this.attrs = {};\n        this.index = 0;\n        this.parent = null;\n        this._cache = new Map();\n        this._lastPos = null;\n        this._batchingTransformChange = false;\n        this._needClearTransformCache = false;\n        this._filterUpToDate = false;\n        this._isUnderCache = false;\n        this.children = emptyChildren;\n        this._dragEventId = null;\n        this.setAttrs(config);\n        this.on(TRANSFORM_CHANGE_STR, function () {\n            if (_this._batchingTransformChange) {\n                _this._needClearTransformCache = true;\n                return;\n            }\n            _this._clearCache(TRANSFORM);\n            _this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);\n        });\n        this.on('visibleChange.konva', function () {\n            _this._clearSelfAndDescendantCache(VISIBLE);\n        });\n        this.on('listeningChange.konva', function () {\n            _this._clearSelfAndDescendantCache(LISTENING);\n        });\n        this.on('opacityChange.konva', function () {\n            _this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);\n        });\n    }\n    Node.prototype.hasChildren = function () {\n        return false;\n    };\n    Node.prototype.getChildren = function () {\n        return emptyChildren;\n    };\n    Node.prototype._clearCache = function (attr) {\n        if (attr) {\n            this._cache.delete(attr);\n        }\n        else {\n            this._cache.clear();\n        }\n    };\n    Node.prototype._getCache = function (attr, privateGetter) {\n        var cache = this._cache.get(attr);\n        if (cache === undefined) {\n            cache = privateGetter.call(this);\n            this._cache.set(attr, cache);\n        }\n        return cache;\n    };\n    Node.prototype._getCanvasCache = function () {\n        return this._cache.get(CANVAS);\n    };\n    Node.prototype._clearSelfAndDescendantCache = function (attr, forceEvent) {\n        this._clearCache(attr);\n        if (forceEvent && attr === ABSOLUTE_TRANSFORM) {\n            this.fire('_clearTransformCache');\n        }\n        if (this.isCached()) {\n            return;\n        }\n        if (this.children) {\n            this.children.each(function (node) {\n                node._clearSelfAndDescendantCache(attr, true);\n            });\n        }\n    };\n    Node.prototype.clearCache = function () {\n        this._cache.delete(CANVAS);\n        this._clearSelfAndDescendantCache();\n        return this;\n    };\n    Node.prototype.cache = function (config) {\n        var conf = config || {};\n        var rect = {};\n        if (conf.x === undefined ||\n            conf.y === undefined ||\n            conf.width === undefined ||\n            conf.height === undefined) {\n            rect = this.getClientRect({\n                skipTransform: true,\n                relativeTo: this.getParent(),\n            });\n        }\n        var width = Math.ceil(conf.width || rect.width), height = Math.ceil(conf.height || rect.height), pixelRatio = conf.pixelRatio, x = conf.x === undefined ? rect.x : conf.x, y = conf.y === undefined ? rect.y : conf.y, offset = conf.offset || 0, drawBorder = conf.drawBorder || false;\n        if (!width || !height) {\n            Util_1.Util.error('Can not cache the node. Width or height of the node equals 0. Caching is skipped.');\n            return;\n        }\n        width += offset * 2;\n        height += offset * 2;\n        x -= offset;\n        y -= offset;\n        var cachedSceneCanvas = new Canvas_1.SceneCanvas({\n            pixelRatio: pixelRatio,\n            width: width,\n            height: height,\n        }), cachedFilterCanvas = new Canvas_1.SceneCanvas({\n            pixelRatio: pixelRatio,\n            width: 0,\n            height: 0,\n        }), cachedHitCanvas = new Canvas_1.HitCanvas({\n            pixelRatio: 1,\n            width: width,\n            height: height,\n        }), sceneContext = cachedSceneCanvas.getContext(), hitContext = cachedHitCanvas.getContext();\n        cachedHitCanvas.isCache = true;\n        this._cache.delete('canvas');\n        this._filterUpToDate = false;\n        if (conf.imageSmoothingEnabled === false) {\n            cachedSceneCanvas.getContext()._context.imageSmoothingEnabled = false;\n            cachedFilterCanvas.getContext()._context.imageSmoothingEnabled = false;\n        }\n        sceneContext.save();\n        hitContext.save();\n        sceneContext.translate(-x, -y);\n        hitContext.translate(-x, -y);\n        this._isUnderCache = true;\n        this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);\n        this._clearSelfAndDescendantCache(ABSOLUTE_SCALE);\n        this.drawScene(cachedSceneCanvas, this, true);\n        this.drawHit(cachedHitCanvas, this, true);\n        this._isUnderCache = false;\n        sceneContext.restore();\n        hitContext.restore();\n        if (drawBorder) {\n            sceneContext.save();\n            sceneContext.beginPath();\n            sceneContext.rect(0, 0, width, height);\n            sceneContext.closePath();\n            sceneContext.setAttr('strokeStyle', 'red');\n            sceneContext.setAttr('lineWidth', 5);\n            sceneContext.stroke();\n            sceneContext.restore();\n        }\n        this._cache.set(CANVAS, {\n            scene: cachedSceneCanvas,\n            filter: cachedFilterCanvas,\n            hit: cachedHitCanvas,\n            x: x,\n            y: y,\n        });\n        return this;\n    };\n    Node.prototype.isCached = function () {\n        return this._cache.has('canvas');\n    };\n    Node.prototype.getClientRect = function (config) {\n        throw new Error('abstract \"getClientRect\" method call');\n    };\n    Node.prototype._transformedRect = function (rect, top) {\n        var points = [\n            { x: rect.x, y: rect.y },\n            { x: rect.x + rect.width, y: rect.y },\n            { x: rect.x + rect.width, y: rect.y + rect.height },\n            { x: rect.x, y: rect.y + rect.height },\n        ];\n        var minX, minY, maxX, maxY;\n        var trans = this.getAbsoluteTransform(top);\n        points.forEach(function (point) {\n            var transformed = trans.point(point);\n            if (minX === undefined) {\n                minX = maxX = transformed.x;\n                minY = maxY = transformed.y;\n            }\n            minX = Math.min(minX, transformed.x);\n            minY = Math.min(minY, transformed.y);\n            maxX = Math.max(maxX, transformed.x);\n            maxY = Math.max(maxY, transformed.y);\n        });\n        return {\n            x: minX,\n            y: minY,\n            width: maxX - minX,\n            height: maxY - minY,\n        };\n    };\n    Node.prototype._drawCachedSceneCanvas = function (context) {\n        context.save();\n        context._applyOpacity(this);\n        context._applyGlobalCompositeOperation(this);\n        var canvasCache = this._getCanvasCache();\n        context.translate(canvasCache.x, canvasCache.y);\n        var cacheCanvas = this._getCachedSceneCanvas();\n        var ratio = cacheCanvas.pixelRatio;\n        context.drawImage(cacheCanvas._canvas, 0, 0, cacheCanvas.width / ratio, cacheCanvas.height / ratio);\n        context.restore();\n    };\n    Node.prototype._drawCachedHitCanvas = function (context) {\n        var canvasCache = this._getCanvasCache(), hitCanvas = canvasCache.hit;\n        context.save();\n        context.translate(canvasCache.x, canvasCache.y);\n        context.drawImage(hitCanvas._canvas, 0, 0);\n        context.restore();\n    };\n    Node.prototype._getCachedSceneCanvas = function () {\n        var filters = this.filters(), cachedCanvas = this._getCanvasCache(), sceneCanvas = cachedCanvas.scene, filterCanvas = cachedCanvas.filter, filterContext = filterCanvas.getContext(), len, imageData, n, filter;\n        if (filters) {\n            if (!this._filterUpToDate) {\n                var ratio = sceneCanvas.pixelRatio;\n                filterCanvas.setSize(sceneCanvas.width / sceneCanvas.pixelRatio, sceneCanvas.height / sceneCanvas.pixelRatio);\n                try {\n                    len = filters.length;\n                    filterContext.clear();\n                    filterContext.drawImage(sceneCanvas._canvas, 0, 0, sceneCanvas.getWidth() / ratio, sceneCanvas.getHeight() / ratio);\n                    imageData = filterContext.getImageData(0, 0, filterCanvas.getWidth(), filterCanvas.getHeight());\n                    for (n = 0; n < len; n++) {\n                        filter = filters[n];\n                        if (typeof filter !== 'function') {\n                            Util_1.Util.error('Filter should be type of function, but got ' +\n                                typeof filter +\n                                ' instead. Please check correct filters');\n                            continue;\n                        }\n                        filter.call(this, imageData);\n                        filterContext.putImageData(imageData, 0, 0);\n                    }\n                }\n                catch (e) {\n                    Util_1.Util.error('Unable to apply filter. ' +\n                        e.message +\n                        ' This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.');\n                }\n                this._filterUpToDate = true;\n            }\n            return filterCanvas;\n        }\n        return sceneCanvas;\n    };\n    Node.prototype.on = function (evtStr, handler) {\n        if (arguments.length === 3) {\n            return this._delegate.apply(this, arguments);\n        }\n        var events = evtStr.split(SPACE), len = events.length, n, event, parts, baseEvent, name;\n        for (n = 0; n < len; n++) {\n            event = events[n];\n            parts = event.split('.');\n            baseEvent = parts[0];\n            name = parts[1] || '';\n            if (!this.eventListeners[baseEvent]) {\n                this.eventListeners[baseEvent] = [];\n            }\n            this.eventListeners[baseEvent].push({\n                name: name,\n                handler: handler,\n            });\n        }\n        return this;\n    };\n    Node.prototype.off = function (evtStr, callback) {\n        var events = (evtStr || '').split(SPACE), len = events.length, n, t, event, parts, baseEvent, name;\n        if (!evtStr) {\n            for (t in this.eventListeners) {\n                this._off(t);\n            }\n        }\n        for (n = 0; n < len; n++) {\n            event = events[n];\n            parts = event.split('.');\n            baseEvent = parts[0];\n            name = parts[1];\n            if (baseEvent) {\n                if (this.eventListeners[baseEvent]) {\n                    this._off(baseEvent, name, callback);\n                }\n            }\n            else {\n                for (t in this.eventListeners) {\n                    this._off(t, name, callback);\n                }\n            }\n        }\n        return this;\n    };\n    Node.prototype.dispatchEvent = function (evt) {\n        var e = {\n            target: this,\n            type: evt.type,\n            evt: evt,\n        };\n        this.fire(evt.type, e);\n        return this;\n    };\n    Node.prototype.addEventListener = function (type, handler) {\n        this.on(type, function (evt) {\n            handler.call(this, evt.evt);\n        });\n        return this;\n    };\n    Node.prototype.removeEventListener = function (type) {\n        this.off(type);\n        return this;\n    };\n    Node.prototype._delegate = function (event, selector, handler) {\n        var stopNode = this;\n        this.on(event, function (evt) {\n            var targets = evt.target.findAncestors(selector, true, stopNode);\n            for (var i = 0; i < targets.length; i++) {\n                evt = Util_1.Util.cloneObject(evt);\n                evt.currentTarget = targets[i];\n                handler.call(targets[i], evt);\n            }\n        });\n    };\n    Node.prototype.remove = function () {\n        if (this.isDragging()) {\n            this.stopDrag();\n        }\n        DragAndDrop_1.DD._dragElements.delete(this._id);\n        this._remove();\n        return this;\n    };\n    Node.prototype._clearCaches = function () {\n        this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);\n        this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);\n        this._clearSelfAndDescendantCache(ABSOLUTE_SCALE);\n        this._clearSelfAndDescendantCache(STAGE);\n        this._clearSelfAndDescendantCache(VISIBLE);\n        this._clearSelfAndDescendantCache(LISTENING);\n    };\n    Node.prototype._remove = function () {\n        this._clearCaches();\n        var parent = this.getParent();\n        if (parent && parent.children) {\n            parent.children.splice(this.index, 1);\n            parent._setChildrenIndices();\n            this.parent = null;\n        }\n    };\n    Node.prototype.destroy = function () {\n        exports._removeId(this.id(), this);\n        var names = (this.name() || '').split(/\\s/g);\n        for (var i = 0; i < names.length; i++) {\n            var subname = names[i];\n            exports._removeName(subname, this._id);\n        }\n        this.remove();\n        return this;\n    };\n    Node.prototype.getAttr = function (attr) {\n        var method = 'get' + Util_1.Util._capitalize(attr);\n        if (Util_1.Util._isFunction(this[method])) {\n            return this[method]();\n        }\n        return this.attrs[attr];\n    };\n    Node.prototype.getAncestors = function () {\n        var parent = this.getParent(), ancestors = new Util_1.Collection();\n        while (parent) {\n            ancestors.push(parent);\n            parent = parent.getParent();\n        }\n        return ancestors;\n    };\n    Node.prototype.getAttrs = function () {\n        return this.attrs || {};\n    };\n    Node.prototype.setAttrs = function (config) {\n        var key, method;\n        if (!config) {\n            return this;\n        }\n        for (key in config) {\n            if (key === CHILDREN) {\n                continue;\n            }\n            method = SET + Util_1.Util._capitalize(key);\n            if (Util_1.Util._isFunction(this[method])) {\n                this[method](config[key]);\n            }\n            else {\n                this._setAttr(key, config[key]);\n            }\n        }\n        return this;\n    };\n    Node.prototype.isListening = function () {\n        return this._getCache(LISTENING, this._isListening);\n    };\n    Node.prototype._isListening = function () {\n        var listening = this.listening(), parent = this.getParent();\n        if (listening === 'inherit') {\n            if (parent) {\n                return parent.isListening();\n            }\n            else {\n                return true;\n            }\n        }\n        else {\n            return listening;\n        }\n    };\n    Node.prototype.isVisible = function () {\n        return this._getCache(VISIBLE, this._isVisible);\n    };\n    Node.prototype._isVisible = function (relativeTo) {\n        var visible = this.visible(), parent = this.getParent();\n        if (visible === 'inherit') {\n            if (parent && parent !== relativeTo) {\n                return parent._isVisible(relativeTo);\n            }\n            else {\n                return true;\n            }\n        }\n        else if (relativeTo && relativeTo !== parent) {\n            return visible && parent._isVisible(relativeTo);\n        }\n        else {\n            return visible;\n        }\n    };\n    Node.prototype.shouldDrawHit = function () {\n        var layer = this.getLayer();\n        return ((!layer && this.isListening() && this.isVisible()) ||\n            (layer &&\n                layer.hitGraphEnabled() &&\n                this.isListening() &&\n                this.isVisible()));\n    };\n    Node.prototype.show = function () {\n        this.visible(true);\n        return this;\n    };\n    Node.prototype.hide = function () {\n        this.visible(false);\n        return this;\n    };\n    Node.prototype.getZIndex = function () {\n        return this.index || 0;\n    };\n    Node.prototype.getAbsoluteZIndex = function () {\n        var depth = this.getDepth(), that = this, index = 0, nodes, len, n, child;\n        function addChildren(children) {\n            nodes = [];\n            len = children.length;\n            for (n = 0; n < len; n++) {\n                child = children[n];\n                index++;\n                if (child.nodeType !== SHAPE) {\n                    nodes = nodes.concat(child.getChildren().toArray());\n                }\n                if (child._id === that._id) {\n                    n = len;\n                }\n            }\n            if (nodes.length > 0 && nodes[0].getDepth() <= depth) {\n                addChildren(nodes);\n            }\n        }\n        if (that.nodeType !== UPPER_STAGE) {\n            addChildren(that.getStage().getChildren());\n        }\n        return index;\n    };\n    Node.prototype.getDepth = function () {\n        var depth = 0, parent = this.parent;\n        while (parent) {\n            depth++;\n            parent = parent.parent;\n        }\n        return depth;\n    };\n    Node.prototype._batchTransformChanges = function (func) {\n        this._batchingTransformChange = true;\n        func();\n        this._batchingTransformChange = false;\n        if (this._needClearTransformCache) {\n            this._clearCache(TRANSFORM);\n            this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM, true);\n        }\n        this._needClearTransformCache = false;\n    };\n    Node.prototype.setPosition = function (pos) {\n        var _this = this;\n        this._batchTransformChanges(function () {\n            _this.x(pos.x);\n            _this.y(pos.y);\n        });\n        return this;\n    };\n    Node.prototype.getPosition = function () {\n        return {\n            x: this.x(),\n            y: this.y(),\n        };\n    };\n    Node.prototype.getAbsolutePosition = function (top) {\n        var haveCachedParent = false;\n        var parent = this.parent;\n        while (parent) {\n            if (parent.isCached()) {\n                haveCachedParent = true;\n                break;\n            }\n            parent = parent.parent;\n        }\n        if (haveCachedParent && !top) {\n            top = true;\n        }\n        var absoluteMatrix = this.getAbsoluteTransform(top).getMatrix(), absoluteTransform = new Util_1.Transform(), offset = this.offset();\n        absoluteTransform.m = absoluteMatrix.slice();\n        absoluteTransform.translate(offset.x, offset.y);\n        return absoluteTransform.getTranslation();\n    };\n    Node.prototype.setAbsolutePosition = function (pos) {\n        var origTrans = this._clearTransform(), it;\n        this.attrs.x = origTrans.x;\n        this.attrs.y = origTrans.y;\n        delete origTrans.x;\n        delete origTrans.y;\n        this._clearCache(TRANSFORM);\n        it = this._getAbsoluteTransform();\n        it.invert();\n        it.translate(pos.x, pos.y);\n        pos = {\n            x: this.attrs.x + it.getTranslation().x,\n            y: this.attrs.y + it.getTranslation().y,\n        };\n        this._setTransform(origTrans);\n        this.setPosition({ x: pos.x, y: pos.y });\n        return this;\n    };\n    Node.prototype._setTransform = function (trans) {\n        var key;\n        for (key in trans) {\n            this.attrs[key] = trans[key];\n        }\n    };\n    Node.prototype._clearTransform = function () {\n        var trans = {\n            x: this.x(),\n            y: this.y(),\n            rotation: this.rotation(),\n            scaleX: this.scaleX(),\n            scaleY: this.scaleY(),\n            offsetX: this.offsetX(),\n            offsetY: this.offsetY(),\n            skewX: this.skewX(),\n            skewY: this.skewY(),\n        };\n        this.attrs.x = 0;\n        this.attrs.y = 0;\n        this.attrs.rotation = 0;\n        this.attrs.scaleX = 1;\n        this.attrs.scaleY = 1;\n        this.attrs.offsetX = 0;\n        this.attrs.offsetY = 0;\n        this.attrs.skewX = 0;\n        this.attrs.skewY = 0;\n        return trans;\n    };\n    Node.prototype.move = function (change) {\n        var changeX = change.x, changeY = change.y, x = this.x(), y = this.y();\n        if (changeX !== undefined) {\n            x += changeX;\n        }\n        if (changeY !== undefined) {\n            y += changeY;\n        }\n        this.setPosition({ x: x, y: y });\n        return this;\n    };\n    Node.prototype._eachAncestorReverse = function (func, top) {\n        var family = [], parent = this.getParent(), len, n;\n        if (top && top._id === this._id) {\n            func(this);\n            return;\n        }\n        family.unshift(this);\n        while (parent && (!top || parent._id !== top._id)) {\n            family.unshift(parent);\n            parent = parent.parent;\n        }\n        len = family.length;\n        for (n = 0; n < len; n++) {\n            func(family[n]);\n        }\n    };\n    Node.prototype.rotate = function (theta) {\n        this.rotation(this.rotation() + theta);\n        return this;\n    };\n    Node.prototype.moveToTop = function () {\n        if (!this.parent) {\n            Util_1.Util.warn('Node has no parent. moveToTop function is ignored.');\n            return false;\n        }\n        var index = this.index;\n        this.parent.children.splice(index, 1);\n        this.parent.children.push(this);\n        this.parent._setChildrenIndices();\n        return true;\n    };\n    Node.prototype.moveUp = function () {\n        if (!this.parent) {\n            Util_1.Util.warn('Node has no parent. moveUp function is ignored.');\n            return false;\n        }\n        var index = this.index, len = this.parent.getChildren().length;\n        if (index < len - 1) {\n            this.parent.children.splice(index, 1);\n            this.parent.children.splice(index + 1, 0, this);\n            this.parent._setChildrenIndices();\n            return true;\n        }\n        return false;\n    };\n    Node.prototype.moveDown = function () {\n        if (!this.parent) {\n            Util_1.Util.warn('Node has no parent. moveDown function is ignored.');\n            return false;\n        }\n        var index = this.index;\n        if (index > 0) {\n            this.parent.children.splice(index, 1);\n            this.parent.children.splice(index - 1, 0, this);\n            this.parent._setChildrenIndices();\n            return true;\n        }\n        return false;\n    };\n    Node.prototype.moveToBottom = function () {\n        if (!this.parent) {\n            Util_1.Util.warn('Node has no parent. moveToBottom function is ignored.');\n            return false;\n        }\n        var index = this.index;\n        if (index > 0) {\n            this.parent.children.splice(index, 1);\n            this.parent.children.unshift(this);\n            this.parent._setChildrenIndices();\n            return true;\n        }\n        return false;\n    };\n    Node.prototype.setZIndex = function (zIndex) {\n        if (!this.parent) {\n            Util_1.Util.warn('Node has no parent. zIndex parameter is ignored.');\n            return this;\n        }\n        if (zIndex < 0 || zIndex >= this.parent.children.length) {\n            Util_1.Util.warn('Unexpected value ' +\n                zIndex +\n                ' for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to ' +\n                (this.parent.children.length - 1) +\n                '.');\n        }\n        var index = this.index;\n        this.parent.children.splice(index, 1);\n        this.parent.children.splice(zIndex, 0, this);\n        this.parent._setChildrenIndices();\n        return this;\n    };\n    Node.prototype.getAbsoluteOpacity = function () {\n        return this._getCache(ABSOLUTE_OPACITY, this._getAbsoluteOpacity);\n    };\n    Node.prototype._getAbsoluteOpacity = function () {\n        var absOpacity = this.opacity();\n        var parent = this.getParent();\n        if (parent && !parent._isUnderCache) {\n            absOpacity *= parent.getAbsoluteOpacity();\n        }\n        return absOpacity;\n    };\n    Node.prototype.moveTo = function (newContainer) {\n        if (this.getParent() !== newContainer) {\n            this._remove();\n            newContainer.add(this);\n        }\n        return this;\n    };\n    Node.prototype.toObject = function () {\n        var obj = {}, attrs = this.getAttrs(), key, val, getter, defaultValue, nonPlainObject;\n        obj.attrs = {};\n        for (key in attrs) {\n            val = attrs[key];\n            nonPlainObject =\n                Util_1.Util.isObject(val) && !Util_1.Util._isPlainObject(val) && !Util_1.Util._isArray(val);\n            if (nonPlainObject) {\n                continue;\n            }\n            getter = typeof this[key] === 'function' && this[key];\n            delete attrs[key];\n            defaultValue = getter ? getter.call(this) : null;\n            attrs[key] = val;\n            if (defaultValue !== val) {\n                obj.attrs[key] = val;\n            }\n        }\n        obj.className = this.getClassName();\n        return Util_1.Util._prepareToStringify(obj);\n    };\n    Node.prototype.toJSON = function () {\n        return JSON.stringify(this.toObject());\n    };\n    Node.prototype.getParent = function () {\n        return this.parent;\n    };\n    Node.prototype.findAncestors = function (selector, includeSelf, stopNode) {\n        var res = [];\n        if (includeSelf && this._isMatch(selector)) {\n            res.push(this);\n        }\n        var ancestor = this.parent;\n        while (ancestor) {\n            if (ancestor === stopNode) {\n                return res;\n            }\n            if (ancestor._isMatch(selector)) {\n                res.push(ancestor);\n            }\n            ancestor = ancestor.parent;\n        }\n        return res;\n    };\n    Node.prototype.isAncestorOf = function (node) {\n        return false;\n    };\n    Node.prototype.findAncestor = function (selector, includeSelf, stopNode) {\n        return this.findAncestors(selector, includeSelf, stopNode)[0];\n    };\n    Node.prototype._isMatch = function (selector) {\n        if (!selector) {\n            return false;\n        }\n        if (typeof selector === 'function') {\n            return selector(this);\n        }\n        var selectorArr = selector.replace(/ /g, '').split(','), len = selectorArr.length, n, sel;\n        for (n = 0; n < len; n++) {\n            sel = selectorArr[n];\n            if (!Util_1.Util.isValidSelector(sel)) {\n                Util_1.Util.warn('Selector \"' +\n                    sel +\n                    '\" is invalid. Allowed selectors examples are \"#foo\", \".bar\" or \"Group\".');\n                Util_1.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like \"Triangle\".');\n                Util_1.Util.warn('Konva is awesome, right?');\n            }\n            if (sel.charAt(0) === '#') {\n                if (this.id() === sel.slice(1)) {\n                    return true;\n                }\n            }\n            else if (sel.charAt(0) === '.') {\n                if (this.hasName(sel.slice(1))) {\n                    return true;\n                }\n            }\n            else if (this.className === sel || this.nodeType === sel) {\n                return true;\n            }\n        }\n        return false;\n    };\n    Node.prototype.getLayer = function () {\n        var parent = this.getParent();\n        return parent ? parent.getLayer() : null;\n    };\n    Node.prototype.getStage = function () {\n        return this._getCache(STAGE, this._getStage);\n    };\n    Node.prototype._getStage = function () {\n        var parent = this.getParent();\n        if (parent) {\n            return parent.getStage();\n        }\n        else {\n            return undefined;\n        }\n    };\n    Node.prototype.fire = function (eventType, evt, bubble) {\n        if (evt === void 0) { evt = {}; }\n        evt.target = evt.target || this;\n        if (bubble) {\n            this._fireAndBubble(eventType, evt);\n        }\n        else {\n            this._fire(eventType, evt);\n        }\n        return this;\n    };\n    Node.prototype.getAbsoluteTransform = function (top) {\n        if (top) {\n            return this._getAbsoluteTransform(top);\n        }\n        else {\n            return this._getCache(ABSOLUTE_TRANSFORM, this._getAbsoluteTransform);\n        }\n    };\n    Node.prototype._getAbsoluteTransform = function (top) {\n        var at;\n        if (top) {\n            at = new Util_1.Transform();\n            this._eachAncestorReverse(function (node) {\n                var transformsEnabled = node.transformsEnabled();\n                if (transformsEnabled === 'all') {\n                    at.multiply(node.getTransform());\n                }\n                else if (transformsEnabled === 'position') {\n                    at.translate(node.x() - node.offsetX(), node.y() - node.offsetY());\n                }\n            }, top);\n            return at;\n        }\n        else {\n            if (this.parent) {\n                at = this.parent.getAbsoluteTransform().copy();\n            }\n            else {\n                at = new Util_1.Transform();\n            }\n            var transformsEnabled = this.transformsEnabled();\n            if (transformsEnabled === 'all') {\n                at.multiply(this.getTransform());\n            }\n            else if (transformsEnabled === 'position') {\n                at.translate(this.x() - this.offsetX(), this.y() - this.offsetY());\n            }\n            return at;\n        }\n    };\n    Node.prototype.getAbsoluteScale = function (top) {\n        var parent = this;\n        while (parent) {\n            if (parent._isUnderCache) {\n                top = parent;\n            }\n            parent = parent.getParent();\n        }\n        var transform = this.getAbsoluteTransform(top);\n        var attrs = transform.decompose();\n        return {\n            x: attrs.scaleX,\n            y: attrs.scaleY,\n        };\n    };\n    Node.prototype.getAbsoluteRotation = function () {\n        return this.getAbsoluteTransform().decompose().rotation;\n    };\n    Node.prototype.getTransform = function () {\n        return this._getCache(TRANSFORM, this._getTransform);\n    };\n    Node.prototype._getTransform = function () {\n        var m = new Util_1.Transform(), x = this.x(), y = this.y(), rotation = Global_1.Konva.getAngle(this.rotation()), scaleX = this.scaleX(), scaleY = this.scaleY(), skewX = this.skewX(), skewY = this.skewY(), offsetX = this.offsetX(), offsetY = this.offsetY();\n        if (x !== 0 || y !== 0) {\n            m.translate(x, y);\n        }\n        if (rotation !== 0) {\n            m.rotate(rotation);\n        }\n        if (skewX !== 0 || skewY !== 0) {\n            m.skew(skewX, skewY);\n        }\n        if (scaleX !== 1 || scaleY !== 1) {\n            m.scale(scaleX, scaleY);\n        }\n        if (offsetX !== 0 || offsetY !== 0) {\n            m.translate(-1 * offsetX, -1 * offsetY);\n        }\n        return m;\n    };\n    Node.prototype.clone = function (obj) {\n        var attrs = Util_1.Util.cloneObject(this.attrs), key, allListeners, len, n, listener;\n        for (key in obj) {\n            attrs[key] = obj[key];\n        }\n        var node = new this.constructor(attrs);\n        for (key in this.eventListeners) {\n            allListeners = this.eventListeners[key];\n            len = allListeners.length;\n            for (n = 0; n < len; n++) {\n                listener = allListeners[n];\n                if (listener.name.indexOf(KONVA) < 0) {\n                    if (!node.eventListeners[key]) {\n                        node.eventListeners[key] = [];\n                    }\n                    node.eventListeners[key].push(listener);\n                }\n            }\n        }\n        return node;\n    };\n    Node.prototype._toKonvaCanvas = function (config) {\n        config = config || {};\n        var box = this.getClientRect();\n        var stage = this.getStage(), x = config.x !== undefined ? config.x : box.x, y = config.y !== undefined ? config.y : box.y, pixelRatio = config.pixelRatio || 1, canvas = new Canvas_1.SceneCanvas({\n            width: config.width || box.width || (stage ? stage.width() : 0),\n            height: config.height || box.height || (stage ? stage.height() : 0),\n            pixelRatio: pixelRatio,\n        }), context = canvas.getContext();\n        context.save();\n        if (x || y) {\n            context.translate(-1 * x, -1 * y);\n        }\n        this.drawScene(canvas);\n        context.restore();\n        return canvas;\n    };\n    Node.prototype.toCanvas = function (config) {\n        return this._toKonvaCanvas(config)._canvas;\n    };\n    Node.prototype.toDataURL = function (config) {\n        config = config || {};\n        var mimeType = config.mimeType || null, quality = config.quality || null;\n        var url = this._toKonvaCanvas(config).toDataURL(mimeType, quality);\n        if (config.callback) {\n            config.callback(url);\n        }\n        return url;\n    };\n    Node.prototype.toImage = function (config) {\n        if (!config || !config.callback) {\n            throw 'callback required for toImage method config argument';\n        }\n        var callback = config.callback;\n        delete config.callback;\n        Util_1.Util._urlToImage(this.toDataURL(config), function (img) {\n            callback(img);\n        });\n    };\n    Node.prototype.setSize = function (size) {\n        this.width(size.width);\n        this.height(size.height);\n        return this;\n    };\n    Node.prototype.getSize = function () {\n        return {\n            width: this.width(),\n            height: this.height(),\n        };\n    };\n    Node.prototype.getClassName = function () {\n        return this.className || this.nodeType;\n    };\n    Node.prototype.getType = function () {\n        return this.nodeType;\n    };\n    Node.prototype.getDragDistance = function () {\n        if (this.attrs.dragDistance !== undefined) {\n            return this.attrs.dragDistance;\n        }\n        else if (this.parent) {\n            return this.parent.getDragDistance();\n        }\n        else {\n            return Global_1.Konva.dragDistance;\n        }\n    };\n    Node.prototype._off = function (type, name, callback) {\n        var evtListeners = this.eventListeners[type], i, evtName, handler;\n        for (i = 0; i < evtListeners.length; i++) {\n            evtName = evtListeners[i].name;\n            handler = evtListeners[i].handler;\n            if ((evtName !== 'konva' || name === 'konva') &&\n                (!name || evtName === name) &&\n                (!callback || callback === handler)) {\n                evtListeners.splice(i, 1);\n                if (evtListeners.length === 0) {\n                    delete this.eventListeners[type];\n                    break;\n                }\n                i--;\n            }\n        }\n    };\n    Node.prototype._fireChangeEvent = function (attr, oldVal, newVal) {\n        this._fire(attr + CHANGE, {\n            oldVal: oldVal,\n            newVal: newVal,\n        });\n    };\n    Node.prototype.setId = function (id) {\n        var oldId = this.id();\n        exports._removeId(oldId, this);\n        _addId(this, id);\n        this._setAttr('id', id);\n        return this;\n    };\n    Node.prototype.setName = function (name) {\n        var oldNames = (this.name() || '').split(/\\s/g);\n        var newNames = (name || '').split(/\\s/g);\n        var subname, i;\n        for (i = 0; i < oldNames.length; i++) {\n            subname = oldNames[i];\n            if (newNames.indexOf(subname) === -1 && subname) {\n                exports._removeName(subname, this._id);\n            }\n        }\n        for (i = 0; i < newNames.length; i++) {\n            subname = newNames[i];\n            if (oldNames.indexOf(subname) === -1 && subname) {\n                exports._addName(this, subname);\n            }\n        }\n        this._setAttr(NAME, name);\n        return this;\n    };\n    Node.prototype.addName = function (name) {\n        if (!this.hasName(name)) {\n            var oldName = this.name();\n            var newName = oldName ? oldName + ' ' + name : name;\n            this.setName(newName);\n        }\n        return this;\n    };\n    Node.prototype.hasName = function (name) {\n        if (!name) {\n            return false;\n        }\n        var fullName = this.name();\n        if (!fullName) {\n            return false;\n        }\n        var names = (fullName || '').split(/\\s/g);\n        return names.indexOf(name) !== -1;\n    };\n    Node.prototype.removeName = function (name) {\n        var names = (this.name() || '').split(/\\s/g);\n        var index = names.indexOf(name);\n        if (index !== -1) {\n            names.splice(index, 1);\n            this.setName(names.join(' '));\n        }\n        return this;\n    };\n    Node.prototype.setAttr = function (attr, val) {\n        var func = this[SET + Util_1.Util._capitalize(attr)];\n        if (Util_1.Util._isFunction(func)) {\n            func.call(this, val);\n        }\n        else {\n            this._setAttr(attr, val);\n        }\n        return this;\n    };\n    Node.prototype._setAttr = function (key, val) {\n        var oldVal = this.attrs[key];\n        if (oldVal === val && !Util_1.Util.isObject(val)) {\n            return;\n        }\n        if (val === undefined || val === null) {\n            delete this.attrs[key];\n        }\n        else {\n            this.attrs[key] = val;\n        }\n        this._fireChangeEvent(key, oldVal, val);\n    };\n    Node.prototype._setComponentAttr = function (key, component, val) {\n        var oldVal;\n        if (val !== undefined) {\n            oldVal = this.attrs[key];\n            if (!oldVal) {\n                this.attrs[key] = this.getAttr(key);\n            }\n            this.attrs[key][component] = val;\n            this._fireChangeEvent(key, oldVal, val);\n        }\n    };\n    Node.prototype._fireAndBubble = function (eventType, evt, compareShape) {\n        if (evt && this.nodeType === SHAPE) {\n            evt.target = this;\n        }\n        var shouldStop = (eventType === MOUSEENTER || eventType === MOUSELEAVE) &&\n            ((compareShape &&\n                (this === compareShape ||\n                    (this.isAncestorOf && this.isAncestorOf(compareShape)))) ||\n                (this.nodeType === 'Stage' && !compareShape));\n        if (!shouldStop) {\n            this._fire(eventType, evt);\n            var stopBubble = (eventType === MOUSEENTER || eventType === MOUSELEAVE) &&\n                compareShape &&\n                compareShape.isAncestorOf &&\n                compareShape.isAncestorOf(this) &&\n                !compareShape.isAncestorOf(this.parent);\n            if (((evt && !evt.cancelBubble) || !evt) &&\n                this.parent &&\n                this.parent.isListening() &&\n                !stopBubble) {\n                if (compareShape && compareShape.parent) {\n                    this._fireAndBubble.call(this.parent, eventType, evt, compareShape);\n                }\n                else {\n                    this._fireAndBubble.call(this.parent, eventType, evt);\n                }\n            }\n        }\n    };\n    Node.prototype._fire = function (eventType, evt) {\n        var events = this.eventListeners[eventType], i;\n        if (events) {\n            evt = evt || {};\n            evt.currentTarget = this;\n            evt.type = eventType;\n            for (i = 0; i < events.length; i++) {\n                events[i].handler.call(this, evt);\n            }\n        }\n    };\n    Node.prototype.draw = function () {\n        this.drawScene();\n        this.drawHit();\n        return this;\n    };\n    Node.prototype._createDragElement = function (evt) {\n        var pointerId = evt ? evt.pointerId : undefined;\n        var stage = this.getStage();\n        var ap = this.getAbsolutePosition();\n        var pos = stage._getPointerById(pointerId) ||\n            stage._changedPointerPositions[0] ||\n            ap;\n        DragAndDrop_1.DD._dragElements.set(this._id, {\n            node: this,\n            startPointerPos: pos,\n            offset: {\n                x: pos.x - ap.x,\n                y: pos.y - ap.y,\n            },\n            dragStatus: 'ready',\n            pointerId: pointerId,\n        });\n    };\n    Node.prototype.startDrag = function (evt) {\n        if (!DragAndDrop_1.DD._dragElements.has(this._id)) {\n            this._createDragElement(evt);\n        }\n        var elem = DragAndDrop_1.DD._dragElements.get(this._id);\n        elem.dragStatus = 'dragging';\n        this.fire('dragstart', {\n            type: 'dragstart',\n            target: this,\n            evt: evt && evt.evt,\n        }, true);\n    };\n    Node.prototype._setDragPosition = function (evt, elem) {\n        var pos = this.getStage()._getPointerById(elem.pointerId);\n        if (!pos) {\n            return;\n        }\n        var newNodePos = {\n            x: pos.x - elem.offset.x,\n            y: pos.y - elem.offset.y,\n        };\n        var dbf = this.dragBoundFunc();\n        if (dbf !== undefined) {\n            var bounded = dbf.call(this, newNodePos, evt);\n            if (!bounded) {\n                Util_1.Util.warn('dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.');\n            }\n            else {\n                newNodePos = bounded;\n            }\n        }\n        if (!this._lastPos ||\n            this._lastPos.x !== newNodePos.x ||\n            this._lastPos.y !== newNodePos.y) {\n            this.setAbsolutePosition(newNodePos);\n            if (this.getLayer()) {\n                this.getLayer().batchDraw();\n            }\n            else if (this.getStage()) {\n                this.getStage().batchDraw();\n            }\n        }\n        this._lastPos = newNodePos;\n    };\n    Node.prototype.stopDrag = function (evt) {\n        var elem = DragAndDrop_1.DD._dragElements.get(this._id);\n        if (elem) {\n            elem.dragStatus = 'stopped';\n        }\n        DragAndDrop_1.DD._endDragBefore(evt);\n        DragAndDrop_1.DD._endDragAfter(evt);\n    };\n    Node.prototype.setDraggable = function (draggable) {\n        this._setAttr('draggable', draggable);\n        this._dragChange();\n    };\n    Node.prototype.isDragging = function () {\n        var elem = DragAndDrop_1.DD._dragElements.get(this._id);\n        return elem ? elem.dragStatus === 'dragging' : false;\n    };\n    Node.prototype._listenDrag = function () {\n        this._dragCleanup();\n        this.on('mousedown.konva touchstart.konva', function (evt) {\n            var _this = this;\n            var shouldCheckButton = evt.evt['button'] !== undefined;\n            var canDrag = !shouldCheckButton || Global_1.Konva.dragButtons.indexOf(evt.evt['button']) >= 0;\n            if (!canDrag) {\n                return;\n            }\n            if (this.isDragging()) {\n                return;\n            }\n            var hasDraggingChild = false;\n            DragAndDrop_1.DD._dragElements.forEach(function (elem) {\n                if (_this.isAncestorOf(elem.node)) {\n                    hasDraggingChild = true;\n                }\n            });\n            if (!hasDraggingChild) {\n                this._createDragElement(evt);\n            }\n        });\n    };\n    Node.prototype._dragChange = function () {\n        if (this.attrs.draggable) {\n            this._listenDrag();\n        }\n        else {\n            this._dragCleanup();\n            var stage = this.getStage();\n            if (stage && DragAndDrop_1.DD._dragElements.has(this._id)) {\n                this.stopDrag();\n            }\n        }\n    };\n    Node.prototype._dragCleanup = function () {\n        this.off('mousedown.konva');\n        this.off('touchstart.konva');\n    };\n    Node.create = function (data, container) {\n        if (Util_1.Util._isString(data)) {\n            data = JSON.parse(data);\n        }\n        return this._createNode(data, container);\n    };\n    Node._createNode = function (obj, container) {\n        var className = Node.prototype.getClassName.call(obj), children = obj.children, no, len, n;\n        if (container) {\n            obj.attrs.container = container;\n        }\n        if (!Global_1._NODES_REGISTRY[className]) {\n            Util_1.Util.warn('Can not find a node with class name \"' +\n                className +\n                '\". Fallback to \"Shape\".');\n            className = 'Shape';\n        }\n        var Class = Global_1._NODES_REGISTRY[className];\n        no = new Class(obj.attrs);\n        if (children) {\n            len = children.length;\n            for (n = 0; n < len; n++) {\n                no.add(Node._createNode(children[n]));\n            }\n        }\n        return no;\n    };\n    return Node;\n}());\nexports.Node = Node;\nNode.prototype.nodeType = 'Node';\nNode.prototype._attrsAffectingSize = [];\nFactory_1.Factory.addGetterSetter(Node, 'zIndex');\nFactory_1.Factory.addGetterSetter(Node, 'absolutePosition');\nFactory_1.Factory.addGetterSetter(Node, 'position');\nFactory_1.Factory.addGetterSetter(Node, 'x', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'y', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'globalCompositeOperation', 'source-over', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'opacity', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'name', '', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'id', '', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'rotation', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addComponentsGetterSetter(Node, 'scale', ['x', 'y']);\nFactory_1.Factory.addGetterSetter(Node, 'scaleX', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'scaleY', 1, Validators_1.getNumberValidator());\nFactory_1.Factory.addComponentsGetterSetter(Node, 'skew', ['x', 'y']);\nFactory_1.Factory.addGetterSetter(Node, 'skewX', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'skewY', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addComponentsGetterSetter(Node, 'offset', ['x', 'y']);\nFactory_1.Factory.addGetterSetter(Node, 'offsetX', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'offsetY', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'dragDistance', null, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'width', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'height', 0, Validators_1.getNumberValidator());\nFactory_1.Factory.addGetterSetter(Node, 'listening', 'inherit', function (val) {\n    var isValid = val === true || val === false || val === 'inherit';\n    if (!isValid) {\n        Util_1.Util.warn(val +\n            ' is a not valid value for \"listening\" attribute. The value may be true, false or \"inherit\".');\n    }\n    return val;\n});\nFactory_1.Factory.addGetterSetter(Node, 'preventDefault', true, Validators_1.getBooleanValidator());\nFactory_1.Factory.addGetterSetter(Node, 'filters', null, function (val) {\n    this._filterUpToDate = false;\n    return val;\n});\nFactory_1.Factory.addGetterSetter(Node, 'visible', 'inherit', function (val) {\n    var isValid = val === true || val === false || val === 'inherit';\n    if (!isValid) {\n        Util_1.Util.warn(val +\n            ' is a not valid value for \"visible\" attribute. The value may be true, false or \"inherit\".');\n    }\n    return val;\n});\nFactory_1.Factory.addGetterSetter(Node, 'transformsEnabled', 'all', Validators_1.getStringValidator());\nFactory_1.Factory.addGetterSetter(Node, 'size');\nFactory_1.Factory.addGetterSetter(Node, 'dragBoundFunc');\nFactory_1.Factory.addGetterSetter(Node, 'draggable', false, Validators_1.getBooleanValidator());\nFactory_1.Factory.backCompat(Node, {\n    rotateDeg: 'rotate',\n    setRotationDeg: 'setRotation',\n    getRotationDeg: 'getRotation',\n});\nUtil_1.Collection.mapMethods(Node);\n"]},"metadata":{},"sourceType":"script"}